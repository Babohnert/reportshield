SYSTEM EXECUTION SCHEMATIC – Compliance Audit (v6.6)

SCOPE
Fixed, rule-locked pipeline that ingests an appraisal PDF, extracts structured text and signals, evaluates compliance checks, and emits a five-section plain-text audit. No markdown, no code blocks, no styling beyond allowed emoji cues. Filenames are fixed. All behavior must remain deterministic and driven by these rules.

EXECUTION OVERVIEW

Ingest

Input: a single PDF (binary). Reject non-PDFs, oversize files, page-count over limit, PDFs with embedded JavaScript or embedded files.

Public mode: when enabled, redact names in Section 1 to [Redacted].

Extract

Primary: Azure Document Intelligence (model = prebuilt-document) on raw bytes.

Collect: full text content, page count, key-value pairs, and tables when available.

Fallback: if Azure extraction fails and local fallback is enabled, extract visible text via safe PDF text reader. KV/tables may be empty in fallback.

Errors: on extraction failure with no fallback, return a structured error per OUTPUT RULES error behavior.

Parse

Derive: Effective Date (favor KV then text), Form Type (marker patterns), Loan Type (VA/FHA/USDA/Conventional markers), Appraiser Name, Client, Subject Address (KV or regex fallback), State (from address), Value Conclusion (money regex + context), Comparables (best-effort from tables/regex for GLA).

Evidence: when a field is derived from text/KV, capture a short evidence snippet and page number where available.

Integrity: detect mismatches between KV vs text for Effective Date and Value Conclusion.

Evaluate Rules (v2.9)

Apply rule set over parsed text and derived fields.

Required checks include, at minimum: 1004MC presence when applicable; VA MPR references in VA context; FHA exhibit/certification in FHA context; Highest & Best Use presence; Subject address extraction; Reconciliation mention vs adjusted range; Fair Housing scan (with exclusions to reduce false positives); optional state hooks patterns.

Each rule yields zero or more Flags with severity (CRITICAL, MODERATE, MINOR), issue text, optional detail, optional evidence, and optional rule id.

Sort flags by severity (CRITICAL, then MODERATE, then MINOR) and by issue.

Assemble Output (Plain Text)

Build Sections 1–4 from parsed metadata and flags exactly as defined in OUTPUT RULES v2.9.

Section 5 is “ADDITIONAL NOTES” and includes the fixed advisories defined in OUTPUT RULES v2.9.

Use a single blank line between sections; no trailing blank lines.

Emoji Decoration

After composition, prepend a single emoji at line start for any line that contains a bracketed label [CRITICAL], [MODERATE], or [MINOR].

Do not modify section headers. Do not add emojis anywhere else.

Return

Return the final five-section plain-text string.

Do not expose internal thresholds, prompts, or system metadata.

INPUT CONSTRAINTS

MAX_MB, MAX_PAGES are enforced. Reject files exceeding limits with clear error lines in Sections 2–4 per OUTPUT RULES error behavior.

Only a single PDF per request. Multipart with multiple files is not supported.

FAIR HOUSING AND PII

Replace detected sensitive phrases/numbers in evidence snippets with […] according to the engine’s redaction helpers.

Do not remove the existence of a concern; redact only within the evidence text shown.

STATE HOOKS

Optional JSON at system/state-hooks.json may define per-state required text patterns. When present and missing in the report text, add a Flag at the configured severity with provided id.

VERSION BINDING

The engine must verify OUTPUT RULES – Compliance Audit (v2.9) contains “v2.9” and SYSTEM EXECUTION SCHEMATIC – Compliance Audit (v6.6) contains “v6.6” before running. Otherwise return configuration error per OUTPUT RULES.

ERROR BEHAVIOR

Use the standard five-section layout. Summarize the error as a [CRITICAL] item in Section 2 and Section 4, and include a concise explanation line in Section 3. Keep Section 1 with placeholders where values are unknown. Include Section 5 advisories.
