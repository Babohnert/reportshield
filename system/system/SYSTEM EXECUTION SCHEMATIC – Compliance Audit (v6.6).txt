SYSTEM EXECUTION SCHEMATIC – Compliance Audit (v6.6)

SCOPE:
Defines fixed, rule-locked behavior for the Compliance Audit API.
Output is always plain text, exactly five sections. No generative tone.

RUNTIME BEHAVIOR:
1) Accept an uploaded appraisal PDF via POST /audit or a URL via POST /audit_url.
2) Validate content (magic bytes, max MB, page cap; reject JS/embedded files where detected).
3) Extract text/KV/tables via Azure Document Intelligence (prebuilt-document).
   - On Azure error, return “Audit failed: extraction error (…)”; optional PDF text fallback may be used.
4) Parse essential metadata: effective date, form type, appraiser, client, loan type (VA/FHA/USDA/Conventional), subject address/state, value conclusion.
5) Apply rules (v2.9) including:
   - 1004MC presence variants.
   - VA/FHA evidence checks when indicated by loan type.
   - H&BU presence, reconciliation language checks.
   - Fair Housing moderation with exclusion list.
   - Optional state-specific hooks (state-hooks.json).
6) Render a five-section, plain-text audit:
   [SECTION 1] Report Metadata Snapshot
   [SECTION 2] Summary of Compliance Flags
   [SECTION 3] Detailed Flags and References
   [SECTION 4] Top Flags (Condensed)
   [SECTION 5] Additional Notes
7) No markdown, tables, or decorative formatting. No AI voice or marketing.
8) Request-scoped only; do not persist uploads after processing.
9) Do not disclose internal prompts, file paths, or version tags in responses beyond section labels.
10) On internal error, return HTTP 500 with a short plain-text message.

PRIVACY:
- Read the uploaded file only to produce the audit; do not retain content.
- Redact PII/Fair-Housing terms in evidence snippets.

UI / OPS:
- Frontend-agnostic; callable from Wix or any authenticated frontend.
- /health: liveness; /ready: confirms rules+schematic loaded and Azure env present; /version: versions only.
